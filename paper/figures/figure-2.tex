\begin{figure}[htbp]
  \centering
  \begin{tikzpicture}[node distance=2cm,scale=0.65, every node/.style={transform shape}]
    % lanes
    \draw [->,>=stealth] (1,0) -- (12,0);
    \draw [->,>=stealth] (1,-2) -- (12,-2);
    \draw [->,>=stealth] (1,-4) -- (12,-4);
    \draw [->,>=stealth] (1,-6) -- (12,-6);

    % \node (S1) at (0.4, 0) {Epoch};
    \node (C) at (0, 0  ) {Coordinator};
    \node (S2) at (0, -2) {Node $N_1$};
    \node (S3) at (0, -4) {Node $N_2$};
    \node (S4) at (0, -6) {Node $N_3$};

    \node (P) at (8, 1.5) {\small{2PC}};
    % \draw [dashed] (2,0.75) -- (11,0.75);
    \draw [dashed] (2,1.25) -- (11,1.25);
    \draw [dashed] (2,1.75) -- (11,1.75);
    \draw [dashed] (5,0.8) -- (11,0.8);

    % execution phase
    \draw [dashed] (2,1.75) -- (2,-7);
    \node (P) at (3.5, 1.5) {\small{WORK}};

    \draw [->,>=stealth] (2.4,-2.2) -- (2.6,-3.8);
    \draw [->,>=stealth] (2.8,-3.8) -- (3.0,-2.2);

    \draw [->,>=stealth] (3.3,-3.8) -- (3.5,-2.2);
    \draw [->,>=stealth] (3.7,-2.2) -- (3.9,-3.8);

    \draw [->,>=stealth] (4.2,-2.2) -- (4.4,-3.8);
    \draw [->,>=stealth] (4.6,-3.8) -- (4.8,-2.2);

    % prepare phase
    \draw [dashed] (5,1.75) -- (5,-7);
    \node (P) at (6.5, 1) {\small{PREPARE}};
    \draw [->,very thick,darkpastelblue,>=stealth] (5.2,-0.2) -- (5.6,-1.8);
    \draw [->,very thick,darkpastelblue,>=stealth] (5.2,-0.2) -- (5.8,-3.8);
    \draw [->,very thick,darkpastelblue,>=stealth] (5.2,-0.2) -- (5.8,-5.8);
    \node[draw,rectangle,minimum size=.5cm,inner sep=0pt,fill=pastelred] at (6,-2) {A};
    \node[draw,rectangle,minimum size=.5cm,inner sep=0pt,fill=pastelred] at (6.2,-4) {A};
    \node[draw,rectangle,minimum size=.5cm,inner sep=0pt,fill=pastelred] at (6.2,-6) {A};
    \draw [->,very thick,darkpastelblue,>=stealth] (7.2,-1.8) -- (7.6,-0.2);
    \draw [->,very thick,darkpastelblue,>=stealth] (7.2,-3.8) -- (7.8,-0.2);
    \draw [->,very thick,darkpastelblue,>=stealth] (7.2,-5.8) -- (7.9,-0.2);

    \node at (9.6, 0.6) {\scriptsize{$c_0=\{N_1, N_2\}, $}};
    \node at (10, 0.3) {\scriptsize{$c_1=\{N_3\}$}};

    \node at (6.6, -2.5) {\scriptsize{$dep=\{n2\}$}};
    \node at (6.6, -4.6) {\scriptsize{$dep=\{n1\}$}};
    \node at (7.2, -6.4) {\scriptsize{$dep=\{\}$}};


    % commit phase
    \draw [dashed] (8,1.25) -- (8,-7);
    \node (CO) at (9.5, 1) {\small{COMMIT}};
    \node[draw,rectangle,minimum size=.5cm,inner sep=0pt,fill=pastelred] at (8.3,0) {B};
    \draw [->,very thick,darkpastelblue,>=stealth] (8.6,-0.2) -- (9.2,-1.8);
    \draw [->,very thick,darkpastelblue,>=stealth] (8.6,-0.2) -- (9.2,-3.8);
    \draw [->,very thick,darkpastelblue,>=stealth] (8.6,-0.2) -- (9.2,-5.8);

    \draw [->,very thick,darkpastelblue,>=stealth] (10,-1.8) -- (10.6,-0.2);
    \draw [->,very thick,darkpastelblue,>=stealth] (10.2,-3.8) -- (10.8,-0.2);
    \draw [->,very thick,darkpastelblue,>=stealth] (10.4,-5.8) -- (10.9,-0.2);

    \draw [dashed] (11,1.75) -- (11,-7);

    \node[draw,circle,minimum size=.5cm,inner sep=0pt] at (4.5,-5.6) {$1$};
    \node[draw,circle,minimum size=.5cm,inner sep=0pt] at (6.3,-5.3) {$2$};
    \node[draw,circle,minimum size=.5cm,inner sep=0pt] at (9.2,-0.5) {$3$};
    \node[draw,circle,minimum size=.5cm,inner sep=0pt] at (8.4,-5.6) {$4$};
  \end{tikzpicture}
  \caption{A cycle in epoch-based multi-commit. A node's epoch-dependency list is indicated as \textit{dep}.
  %Various failure scenarios are numbered from 1 to 4.
  %Durable writes are indicated by red squares and 2PC messages by blue arrows.
  }
  \label{fig:ebmc}
\end{figure}